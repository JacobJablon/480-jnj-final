<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kodak</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- Pure three.js code that the A-Frame components use for location-based AR -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js'></script>
    <!-- AR.js A-Frame components (recommended to use version 3.4.5, rather than master) -->
    <script src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js'></script>
    <!-- Animation Components -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>


    <!-- Howler.js for audio playback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"
        integrity="sha512-xi/RZRIF/S0hJ+yJJYuZ5yk6/8pCiRlEXZzoguSMl+vk2i3m6UjUO/WcZ11blRL/O+rnj94JRGwt/CHbc9+6EA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link href="../styles/poiLocations.css" rel="stylesheet">
    <script src="../src/poiLocations.js"></script>
</head>

<body>
    <a-scene arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true" id="scene">

        <a-assets>
            <a-asset-item id="xerox-Tower" src="../assets/XeroxScene/xeroxT/result.gltf"></a-asset-item>
            <a-asset-item id="kodak-Tower" src="../assets/XeroxScene/kodakT/result.gltf"></a-asset-item>
            <a-asset-item id="bal-Tower" src="../assets/XeroxScene/bLHeadQuarters/result.gltf"></a-asset-item>
            <a-asset-item id="group" src="../assets/Kodakscene/manObj/scene.gltf"></a-asset-item>
            <a-asset-item id="man" src="../assets/Kodakscene/groupObj/scene.gltf"></a-asset-item>
            <!-- <a-asset-item id="canon-camera" src="../assets/Kodakscene/canonCam/scene.gltf"></a-asset-item>
            <a-asset-item id="vintage-camera" src="../assets/Kodakscene/vintage_camera/scene.gltf"></a-asset-item> -->
            <a-asset-item id="kodak-camera" src="../assets/Kodakscene/kodakCam/scene.gltf"></a-asset-item>
            <a-asset-item id="fuji-camera" src="../assets/Kodakscene/fujiCam/scene.gltf"></a-asset-item>
            <a-asset-item id="decline-graph" src="../assets/XeroxScene/DeclineG/DeclineG.gltf"></a-asset-item>

            <img id="kodakView" src="../assets/Kodakscene/kodakView.png" />
            <img id="georgeE" src="../assets/Kodakscene/georgeE.png" />
            <img id="youPush" src="../assets/Kodakscene/youPushAd.jpg" />
        </a-assets>

        <a-camera gps-new-camera='gpsMinDistance: 5'></a-camera>

        <!-- Overall container entity that holds every other entity -->
        <a-entity id="everything-container" rotation="0 0 0" position="0 0 -10">
            <a-entity id="buildingContainer" visible="false">
                <a-entity id="kT" position="0 0 0">
                    <a-entity gltf-model="#kodak-Tower" scale="2 1.5 2">
                    </a-entity>
                    <a-entity position="0 3.5 0" text="value:Kodak; width:10; align:center ">
                    </a-entity>
                    <a-entity id="groupK" class="groupMover" gltf-model="#group" position="-0.30116 0 -0.09705"
                        scale="0.1 0.1 0.1">
                    </a-entity>
                    <a-entity id="kodakGraph" gltf-model="#decline-graph" position="0 4.5 0" scale="0.01 0.01 0.01"
                        rotation="90 0 0">
                    </a-entity>
                </a-entity>
                <a-entity id="xT" position="-3 0 0">
                    <a-entity gltf-model="#xerox-Tower" scale="0.02 0.015 0.02">
                    </a-entity>
                    <a-entity position="0 3 0" text="value:Xerox; width:10; align:center ">
                    </a-entity>
                    <a-entity id="groupT" class="groupMover" gltf-model="#group" position="-0.30116 0 -0.09705"
                        scale="0.1 0.1 0.1">
                    </a-entity>
                    <a-entity gltf-model="#decline-graph" position="0 4 0" scale="0.01 0.01 0.01" rotation="90 0 0">
                    </a-entity>

                </a-entity>
                <a-entity id="blT" position="3 0 0">
                    <a-entity gltf-model="#bal-Tower" scale="0.02 0.02 0.02">
                    </a-entity>
                    <a-entity position="0 3 0" text="value:Bauch&Lomb; width:10; align:center ">
                    </a-entity>
                    <a-entity id="groupB" class="groupMover" gltf-model="#group" position="-0.30116 0 -0.09705"
                        scale="0.1 0.1 0.1">
                    </a-entity>
                    <a-entity gltf-model="#decline-graph" position="0 4 0" scale="0.01 0.01 0.01" rotation="90 0 0">
                    </a-entity>
                </a-entity>

            </a-entity>

            <a-entity id="imagesContainer" visible="false" position="0 3 0">
                <a-image id="kodak-img" src="#kodakView" visible="false" rotation="0 0 0" scale="3.716 3.716 3.716"
                    material="" position="2.6 0 5"></a-image>
                <a-image id="george-img" src="#georgeE" visible="false" rotation="0 -20 0" scale="3.716 3.716 3.716"
                    position="1.54013 -0.11264 5"></a-image>
                <a-image id="push-img" src="#youPush" visible="false" rotation="0 0 0" scale="3.7 3.7 3.7 "
                    position="1 4 5"></a-image>
            </a-entity>




            <!-- <a-entity id="cameraContainer" visible="false" position="0 0 0" scale="0.1 0.1 0.1">
                <a-entity id="fujiCamera" gltf-model="#fuji-camera" rotation="180 0 180" position="0 0 0"
                    scale="0.1 0.1 0.1">
                </a-entity>
                <a-entity id="cannonCam" gltf-model="#canon-camera" position="-3 0 0" scale="0.02 0.02 0.02">
                </a-entity>
                <a-entity id="vintageCam" gltf-model="#vintage-camera" position="-3 0 1" rotation="0 90 0"
                    scale="15 15 15">
                </a-entity>
            </a-entity> -->

            <a-entity id="kodakSuccessContainer">
                <a-entity id="kodakCam" gltf-model="#kodak-camera" visible="false" position="-3 0 0" scale="10 10 10">
                </a-entity>
                <a-entity id="manFree" gltf-model="#man" visible="false" position="-3 -1 0" scale="1.7 1.7 1.7">
                </a-entity>
                <a-entity id="groupFree" gltf-model="#group" visible="false" position="2 0 0" scale="1 1 1">
                </a-entity>
            </a-entity>



        </a-entity>

    </a-scene>

    <div id="UI">

    </div>

</body>

<script>

    window.onload = () => {
        document.querySelector('a-scene').setAttribute('timeline-control', '');
    }

    const buildTimeline = () => {




        const tl = gsap.timeline({ paused: true });

        const images = document.querySelector("#imagesContainer");
        const kodakImg = document.querySelector("#kodak-img");
        const georgeImg = document.querySelector("#george-img");
        const kodakCam = document.querySelector("#kodakCam");
        const pushImg = document.querySelector("#push-img");
        // const fujiCam = document.querySelector("#fujiCamera");
        // const cannonCam = document.querySelector("#cannonCam");
        // const vintageCam = document.querySelector("#vintageCam");
        const groupK = document.querySelector("#groupK");
        const groupT = document.querySelector("#groupT");
        const groupB = document.querySelector("#groupB");
        const buildingContainer = document.querySelector("#buildingContainer");
        // const kT = document.querySelector("#kT");
        // const xT = document.querySelector("#xT");
        // const blT = document.querySelector("#blT");
        const groupFree = document.querySelector("#groupFree");
        const manFree = document.querySelector("#manFree");
        const kodakSuccessContainer = document.querySelector("#kodakSuccessContainer");
        const cameraContainer = document.querySelector("#cameraContainer");

        const movers = document.querySelectorAll('.groupMover');


        tl.call(() => {
            images.setAttribute('visible', true);
        }, null, 0)
            .call(() => {
                kodakImg.setAttribute('visible', true);
            }, null, ">+=1")
            .call(() => {
                kodakImg.setAttribute('visible', false);
            }, null, 9)
            .call(() => {
                kodakCam.setAttribute('visible', true);
                georgeImg.setAttribute('visible', true);
            }, null, "<")
            .to(kodakCam.object3D.rotation, {
                y: Math.PI * 6,
                duration: 11
            }, null, ">")
            .call(() => {
                pushImg.setAttribute('visible', true);
            }, null, 24)
            .to(kodakCam.object3D.position, {
                y: 3,
                duration: 2
            }, null, ">+=8")
            .to(kodakCam.object3D.scale, {
                x: 3, y: 3, z: 3, duration: 4, ease: "power1.out"
            }, "<")
            .call(() => {
                manFree.setAttribute('visible', true);
            }, null, "<+=3")
            .call(() => {
                georgeImg.setAttribute('visible', false);
                pushImg.setAttribute('visible', false);
                groupFree.setAttribute('visible', true);
            }, null, ">+3")
            .to(kodakCam.object3D.position, {
                x: 3,
                y: 2,
                duration: 3
            }, null, ">")
            .to(kodakCam.object3D.scale, {
                x: 6, y: 6, z: 6, duration: 3, ease: "power1.out"
            }, "<")
            // .call(() => {
            //     cameraContainer.setAttribute('visible', true);
            // }, null, "<")
            // .to(cameraContainer.object3D.scale, {
            //     x: 1.5, y: 1.5, z: 1.5, duration: 2, ease: "bounce.out"
            // }, "<")
            .call(() => {
                // cameraContainer.setAttribute('visible', false);
                kodakSuccessContainer.setAttribute('visible', false);
            }, null, 45)
            .call(() => {
                buildingContainer.setAttribute('visible', true);
            }, null, "<")
            .to(buildingContainer.object3D.scale, {
                x: 2, y: 2, z: 2, duration: 2, ease: "bounce.out"
            }, ">")
            .to(buildingContainer.object3D.scale, {
                x: 0.6, y: 0.6, z: 0.6, duration: 22, ease: "steps(11)",
            }, ">+=5")
            .call(() => {

            }, null, "<+=4")

        movers.forEach((el) => {
            const obj = el.object3D;
            const startPos = obj.position.clone();

            // Create a nested timeline for each mover
            const moveTl = gsap.timeline({ repeat: 30, });

            moveTl.to(obj.position, {
                z: startPos.z + 5,
                duration: 0.5,
                ease: "power1.inOut"
            })
                .call(() => {
                    obj.position.set(startPos.x, startPos.y, startPos.z);
                });

            // Add the nested timeline to the main timeline
            tl.add(moveTl, "<"); // “>” makes it run after everything else
        });






        return tl;
    }


    AFRAME.registerComponent('timeline-control', {
        init: function () {





            const sound = new Howl({
                src: ["../audio/Kodak.mp3"],

            });
            // load captions from JSON file
            let captions = [];
            //change for each scene
            loadCaptions(2).then((captions) => {
                // console.log(captions);
                // Now you'll see the actual parsed captions
                setInterval(() => {
                    if (sound.playing()) {
                        const currentTime = sound.seek();// get current playback time
                        const currentCaption = captions.find(cue =>
                            currentTime >= cue.start && currentTime <= cue.end
                        );

                        captionDisplay.innerHTML = currentCaption ? currentCaption.text : "";
                    }
                }, 100);
            });


            // Load the UI

            //Load the time line
            const timeline = buildTimeline();

            let UI = document.querySelector("#UI");
            loadUI(2, UI);

            // Add onClick events
            let startBtn = document.getElementById("startBtn")
            startBtn.addEventListener("click", () => {
                sound.play();
                timeline.play(); // play from the beginning
                startBtn.style.display = "none";
            });

            const captionDisplay = document.getElementById("captionBox");

            document.getElementById("restartBtn").addEventListener("click", () => {
                sound.stop(); // stop resets the playback and stops it
                sound.play();
                // timeline.revert();
                // timeline.restart();// play from the beginning
            });

            document.getElementById("mapBtn").addEventListener("click", () => {
                sound.stop(); // stop resets the playback and stops it
                // timeline.stop(); // stop the timeline

                window.location.href = `../map.html?startingLocation=kodak`;
            });

        }
    });


</script>

</html>